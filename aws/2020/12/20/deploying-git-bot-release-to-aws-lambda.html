<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>Deploying git bot release to AWS lambda</title>
    <meta name="description"
      content="Git bot is a monolith application written in slim and it uses twig as a viewrender.">

    <link rel="canonical" href="https://marabesi.com/aws/2020/12/20/deploying-git-bot-release-to-aws-lambda.html">
    <link rel="alternate" type="application/rss+xml" title="Marabesi"
      href="https://marabesi.com/feed.xml">

    <meta property="og:title" content="Deploying git bot release to AWS lambda" />
    <meta property="og:site_name" content="marabesi.com" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://marabesi.com/aws/2020/12/20/deploying-git-bot-release-to-aws-lambda.html" />
    <meta property="og:image:alt" content="" />
    <meta property="og:image"
      content="https://marabesi.com/images/posts/2020-12-20-deploying-git-bot-release-to-aws-lambda/cover.jpg" />
    <meta property="og:description"
      content="Git bot is a monolith application written in slim and it uses twig as a viewrender." />

    <meta property="fb:app_id" content="536384943068161" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@MatheusMarabesi">
    <meta name="twitter:title" content="Deploying git bot release to AWS lambda">
    <meta name="twitter:description"
      content="Git bot is a monolith application written in slim and it uses twig as a viewrender.">
    <meta name="twitter:creator" content="@MatheusMarabesi">
    <meta name="twitter:image:src"
      content="https://marabesi.com/images/posts/2020-12-20-deploying-git-bot-release-to-aws-lambda/cover.jpg">

    <meta name="author" content="Matheus Marabesi">
    <meta name="publish_date" property="og:publish_date" content="2020-12-20 04:06:05 +0000">

    <meta name="keywords" content="bref,key,section,credentials,command,aws,access,setting,php7,serverless,Serverless,php,application,Stack,app,bot,git,deploy,api,file,dependencies,AWS" />

    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">

    <link href="/assets/main-bundle.css" rel="stylesheet" />

    <!-- See https://goo.gl/OOhYW5 -->
    <link rel="manifest" href="/manifest.json">

    <!-- See https://goo.gl/qRE0vM -->
    <meta name="theme-color" content="#3f51b5">

    <!-- Add to homescreen for Chrome on Android. Fallback for manifest.json -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Marabesi">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Marabesi">

    <!-- Homescreen icons -->
    <link rel="apple-touch-icon" href="/images/manifest/icon-48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/manifest/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/images/manifest/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/manifest/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/images/manifest/icon-192x192.png">

    <!-- Tile icon for Windows 8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="/images/manifest/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#3f51b5">
    <meta name="msapplication-tap-highlight" content="no">
  </head>

  <body class="font-sans overflow-x-hidden">
    <button class="update-button w-full text-white bg-marabesi-purple p-5 m-auto fixed pin-b z-50 hidden focus:outline-none font-bold">Update found, click to update</button>

    <div class="menu-wrapper flex fixed w-full bg-white z-50">
      <nav class="top-menu hidden md:flex justify-start container lg:justify-center md:m-auto md:pt-2 md:pb-2">
        <a href="/" class="hidden md:block">
          <img class="logo w-18 p-1" data-src="/images/logo.png" width="100" alt="marabesi.com logo - two m's and one dot" title="marabesi.com logo - two m's and one dot" />
        </a>

        <ul id="menu-list" class="container-menu hidden flex-col pl-5 md:flex md:pl-0 md:flex-row md:m-auto lg:m-0">
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/talks">
                Talks
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/about">
                About
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/newbie-guide">
                Dev guide
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/resources">
                software development
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/tests/">
                Tests
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/agenda">
                Conferences
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/projects">
                Side projects
              </a>
            </li>
          
          
        </ul>
      </nav>

      <div class="w-full flex items-center h-12 pl-2 bg-white md:hidden">
        <svg id="menu" class="cursor-pointer w-10 h-10 p-2 text-marabesi-pink fill-current" xmlns="http://www.w3.org/2000/svg"
          x="0px" y="0px" width="50" height="50" viewBox="0 0 24 24">
          <path
            style="line-height:normal;text-indent:0;text-align:start;text-decoration-line:none;text-decoration-style:solid;text-decoration-color:#000;text-transform:none;block-progression:tb;isolation:auto;mix-blend-mode:normal"
            d="M 2 5 L 2 7 L 22 7 L 22 5 L 2 5 z M 2 11 L 2 13 L 22 13 L 22 11 L 2 11 z M 2 17 L 2 19 L 22 19 L 22 17 L 2 17 z"
            font-weight="400" font-family="sans-serif" white-space="normal" overflow="visible"></path>
        </svg>
      </div>
    </div>

    <div class="flex flex-col items-center justify-center p-5">
      <input type="text" id="search-input" placeholder="search" aria-label="search" class="focus:outline-none border border-marabesi-purple text-marabesi-purple w-full p-3 mb-2 container mt-20 lg:mt-12">
      <ul id="results-container"></ul>
    </div>

    <div class="shell-content">
      
        <div class="banner-highlight">
          <p class="font-normal text-lg py-4 md:text-3xl lg:text-4xl">
            <span class="apostrophe">‚Äò‚Äò</span>
            Code should be easy to understand.
            <span class="apostrophe">‚Äô‚Äô</span>
          </p>
          <p class="author text-xs">Dustin Boswell and Trevor Foucher - The Art Of Readable Code</p>
        </div>
      

        <div class="page-content container flex flex-col p-1 m-auto">
  
    <main class="mb-5 lg:flex">
      <div class="w-full pl-5 pr-5 lg:w-3/4">
        <h1 id="deploying-git-bot-release-to-aws-lambda">Deploying git bot release to AWS lambda</h1>

        <p>Git bot is a monolith application written in slim and it uses twig as a view
render.</p>

<h2 id="requirements">Requirements</h2>

<p><em>This section asumes a linux based system (debian/ubuntu), but the commands
presented can be arranged to fit another distros as well.</em></p>

<p>The basic setup is to follow the bref documentatino guide on setting things up,
but, this section lists the basic language requirements, version and additional
credentials needed from AWS. The general requirements are as follows:</p>

<ol>
  <li>Aws account and security credentials generated (for this post I assume the root account)</li>
  <li>PHP 7.4+</li>
  <li>Node Js 14+</li>
</ol>

<p>The credentials (1) are downloaded from the <a href="https://console.aws.amazon.com/iam/home?#security_credential" target="_blank">aws console</a>
under the section <strong>Access keys (access key ID and secret access key)</strong>. Clicking on
‚ÄúCreate New Access Key‚Äù will generate the credentials and download a csv file
with the content.</p>

<p>Installing PHP(2) and its dependencies:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>php7.4 php7.4-mbstring php7.4-xml php7.4-dom php7.4-curl
</code></pre></div></div>

<p>Installing Nodejs(3) and its dependencies:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>nvm <span class="o">&amp;&amp;</span> <span class="se">\</span>
    nvm <span class="nb">install </span>node 14 <span class="o">&amp;&amp;</span> <span class="se">\</span>
    nvm use 14 <span class="se">\</span>
    npm <span class="nb">install</span> <span class="nt">-g</span> serverless
</code></pre></div></div>

<h2 id="setting-up-bref">Setting up bref</h2>

<p>To follow this section is a must to finish the requirements section and to have
the credentials in place.</p>

<p>Setting up bref in a php project is a matter to run the installation command
with composer. For all the commands in this section I assume the working directory
as the one from the cloned repo: <code class="language-plaintext highlighter-rouge">/home/Projects/git-bot-release</code>.</p>

<p>The following command installs bref and its dependencies, as described in
the official bref documentation
<a class="citation" href="#bref_documentation">[1]</a>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>serverless config credentials <span class="nt">--provider</span> aws <span class="nt">--key</span> YOUR_ACCESS_KEY <span class="nt">--secret</span> YOUR_SECRET_KEY
</code></pre></div></div>

<p>Replace <strong>YOU_ACCESS_KEY</strong> by the key in the <strong>AWSAccessKeyId</strong> and <strong>YOUR_SECRET_KEY</strong>
by <strong>AWSSecretKey</strong>. The values for each one are in the security credentials
generated in the previous section.</p>

<p>A successfull response for the command should look like:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Serverless: Setting up AWS...
</code></pre></div></div>

<p>Finally, for setting up bref to the project run the composer command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bref/bref
</code></pre></div></div>

<p>The last command to initialize bref is to run the init script with the following
command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/bref init
</code></pre></div></div>

<p>The command will prompt the following question:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> vendor/bin/bref init

 What kind of lambda <span class="k">do </span>you want to create? <span class="o">(</span>you will be able to add more functions later by editing <span class="sb">`</span>serverless.yml<span class="sb">`</span><span class="o">)</span> <span class="o">[</span>Web application]:
  <span class="o">[</span>0] Web application
  <span class="o">[</span>1] Event-driven <span class="k">function</span>
</code></pre></div></div>

<p>As gitbot is a web application I chose <code class="language-plaintext highlighter-rouge">0</code>, and the response to the input was
as follows:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Creating serverless.yml
Creating index.php

                                                                                                         
 <span class="o">[</span>OK] Project initialized and ready to <span class="nb">test </span>or deploy.                                                   
                                                                                                         
      The files created were automatically added to git.   
</code></pre></div></div>

<h2 id="deploying">Deploying</h2>

<p>To deploy the application to aws, the command is:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>serverless deploy
</code></pre></div></div>

<p>Note that the deployment in this stage is done via node and not php. Bref
takes advantage of the work done in the serverless package to automate this step.
This step will deploy the application as it is and the output log looks
like:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Serverless: Deprecation warning: Starting with next major version, default value of provider.lambdaHashingVersion will be equal to <span class="s2">"20201221"</span>
            More Info: https://www.serverless.com/framework/docs/deprecations/#LAMBDA_HASHING_VERSION_V2
Serverless: Packaging service...
Serverless: Excluding development dependencies...
Serverless: Creating Stack...
Serverless: Checking Stack create progress...
........
Serverless: Stack create finished...
Serverless: Uploading CloudFormation file to S3...
Serverless: Uploading artifacts...
Serverless: Uploading service app.zip file to S3 <span class="o">(</span>17.35 MB<span class="o">)</span>...
Serverless: Validating template...
Serverless: Updating Stack...
Serverless: Checking Stack update progress...
..............................
Serverless: Stack update finished...
Service Information
service: app
stage: dev
region: us-east-1
stack: app-dev
resources: 11
api keys:
  None
endpoints:
  ANY - https://jajaj188181.execute-api.us-east-1.amazonaws.com
functions:
  api: app-dev-api
layers:
  None
</code></pre></div></div>

<p>At this point, the deployment is completed and accessing the endpoint provided
should show up the bref logo.</p>

<p><a href="/images/posts/2020-12-20-deploying-git-bot-to-aws-lambda/bref.png" target="_blank"><img src="/images/posts/2020-12-20-deploying-git-bot-to-aws-lambda/bref.png" alt="bref welcome image" title="bref welcome image" /></a></p>

<h2 id="updating-the-deployed-app-and-env-variables">Updating the deployed app and env variables</h2>

<p>By default the <code class="language-plaintext highlighter-rouge">serverless.yml</code> points to a file <code class="language-plaintext highlighter-rouge">index.php</code> in the root of the
project, therefore, git bot uses the file in the <code class="language-plaintext highlighter-rouge">public/index.php</code> instead.
Changing the parameter <code class="language-plaintext highlighter-rouge">handler</code> under <code class="language-plaintext highlighter-rouge">api</code> fix the index path.</p>

<p>Once the change is in place, the command <code class="language-plaintext highlighter-rouge">serverless deploy</code> also updates
the app code to reflect the change.</p>

<h2 id="references">References</h2>

<ol class="bibliography"><li><span id="bref_documentation">[1]bref.sh, ‚ÄúInstallation,‚Äù 2021 [Online]. Available at: <a href="https://bref.sh/docs/installation.html" target="_blank">https://bref.sh/docs/installation.html</a>. [Accessed: 04-Jan-2021]</span></li></ol>

      </div>
      <div class="hidden w-1/4 lg:block">
        <div class="sticky pin-t pl-2 xl:top-30">
          
          <h2 id="table-of-contents">Table of contents</h2>

<ol>
  <li><a href="#deploying-git-bot-release-to-aws-lambda">Introduction</a></li>
  <li><a href="#requirements">Requirements</a></li>
  <li><a href="#setting-up-bref">Setting up bref</a></li>
  <li><a href="#deploying">Deploying</a></li>
  <li><a href="#references">References</a></li>
</ol>


          <h2>Share this on</h2>

          <div class="flex -ml-2">
            

<style>
#share-buttons {display: flex; justify-content: center; align-items: center;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #f12f46; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<div id="share-buttons" class="mb-5">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https://marabesi.com/aws/2020/12/20/deploying-git-bot-release-to-aws-lambda.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=https://marabesi.com/aws/2020/12/20/deploying-git-bot-release-to-aws-lambda.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https://marabesi.com/aws/2020/12/20/deploying-git-bot-release-to-aws-lambda.html&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
</div>
          </div>

          <h2>You also might like</h2>

          
          
          

          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
              <div class="mt-4 mb-4">
                <a href="/nodejs/jsnad/2021/01/16/node-certification-jsnad-streams.html">Node.js certification JSNAD - Streams [  <span class="text-marabesi-pink">file,</span>  <span class="text-marabesi-pink">application,</span>  ]</a>
              </div>
              
              
            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
              <div class="mt-4 mb-4">
                <a href="/aws/ccp/2021/01/07/aws-cloud-practitioner-notes-storage-and-databases.html">AWS cloud practitioner notes - Storage and databases [  <span class="text-marabesi-pink">aws,</span>  <span class="text-marabesi-pink">application,</span>  ]</a>
              </div>
              
              
            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
          
            
            

            

            
              <div class="mt-4 mb-4">
                <a href="/devops/2020/07/19/git-release-bot-part-1.html">Git release bot - PART 1 [  <span class="text-marabesi-pink">file,</span>  <span class="text-marabesi-pink">git,</span>  ]</a>
              </div>
              
              
            
          
            
            

            

            
              <div class="mt-4 mb-4">
                <a href="/web/2020/07/07/lambda-first-impressions.html">Lambda (AWS) - first impressions [  <span class="text-marabesi-pink">aws,</span>  <span class="text-marabesi-pink">application,</span>  ]</a>
              </div>
              
              
                
        </div>
      </div>
    </main>
  


  <div id="disqus_thread"></div>
</div>

      <div class="footer">
        <div class="footer-details">
          Made with üíñ by <a href="https://twitter.com/MatheusMarabesi" target="_blank">@MatheusMarabesi</a>
        </div>
      </div>
    </div>

    
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-58623708-1', 'auto');
      ga('send', 'pageview');
    </script>
    

    <script async src="/assets/main-bundle.js"></script>
  </body>
</html>